
[![Build][build-badge]][build-url]
[![Issues][issues-badge]][issues-url]
[![Gitter][gitter-badge]][gitter-url]

# Azure Stream Analytics Manager Overview

ASA-manager micro-serivce is available only in dotnet. This folder contains the scripts required to run asa-manager as a docker container locally.
To run the service as a container:

The ASA job is supported by two 
[reference data](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-use-reference-data)
sets: one that defines rules and one that defines device groups.
Rules are stored in json format and device groups are stored in csv format.

The rules reference data is generated by the information managed by 
the [Telemetry Microservice][telemetry-microservice-url].

This microservice transforms telemetry rules into stream
processing logic.

The device groups reference data is used to
identify which group of rules to apply to an
incoming telemetry message.
The device groups are managed by the
[Configuration Microservice][configuration-microservice-url]
and use Azure IoT Hub device twin queries.

## Why?

This microservice was built as part of the 
[Azure IoT Remote Monitoring](https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet) 
project to provide a generic implementation for an end-to-end IoT solution. 
More information [here][rm-arch-url].

## Features

* Manage ASA jobs
* Export rules defined in the
  [Telemetry Microservice][telemetry-microservice-url] to ASA
* Export device groups defined in the
  [Configuration Microservice][configuration-microservice-url] for ASA consumption

# How to use

## Running the service locally

## Prerequisites

### 1. Install docker-compose.
### 2. Set environment variables
In order to run the service, some environment variables need to be created 
at least once. See specific instructions for IDE or command line setup below
for more information. More information on environment variables
[here](#configuration-and-environment-variables).

* `PCS_AAD_APPID` = { Azure service principal id }
* `PCS_AAD_APPSECRET` = { Azure service principal secret }
* `PCS_KEYVAULT_NAME` = { Name of Key Vault resource that stores settings and configuration }

### 2.1 Settings used from Key Vault
Some of the configuration needed by the microservice is stored in an instance of Key Vault that was created on initial deployment. The auth microservice uses:

* `documentDBConnectionString` = { Azure Cosmos DB connection string }
* `telemetryWebServiceUrl ` = http://localhost:9004/v1
* `configWebServiceUrl ` = http://localhost:9005/v1
* `iothubmanagerWebServiceUrl` = http://localhost:9002/v1
* `storageAccountName` = { Azure Blob Storage account name }
* `storageAccountKey` = { Azure Blob Storage Key }
* `storageEndpointSuffix` = { Azure Blob Storage endpoint suffix, 
   ex. "core.windows.net" }
* `messagesEventHubConnectionString` = { Event Hub Connection String for RootManageSharedAccessKey }
* `messagesEventHubName` = { Name of Event Hub }
* `telemetryStorageType` = { "tsi" or "cosmosdb", default is "tsi" }

3. Start the ASA manager service using docker compose:
   ```
   cd scripts
   cd docker
   docker-compose up
   ```


## Configuration and Environment variables

The service configuration is accessed via ASP.NET Core configuration
adapters, and stored in [appsettings.ini](WebService/appsettings.ini).
The INI format allows to store values in a readable format, with comments.

The configuration also supports references to environment variables, e.g. to
import credentials and network details. Environment variables are not
mandatory though, you can for example edit appsettings.ini and write
credentials directly in the file. Just be careful not sharing the changes,
e.g. sending a Pull Request or checking in the changes in git.

The configuration file in the repository references some environment
variables that need to be defined. Depending on the OS and the IDE used,
there are several ways to manage environment variables.

1. If you're using Visual Studio or Visual Studio for Mac, the environment
   variables are loaded from the project settings. Right click on WebService,
   and select Options/Properties, and find the section with the list of env
   vars. See [WebService/Properties/launchSettings.json](WebService/Properties/launchSettings.json).
1. Visual Studio Code loads the environment variables from
   [.vscode/launch.json](.vscode/launch.json)
1. When running the service **with Docker** or **from the command line**, the
   application will inherit environment variables values from the system. 
   * [This page][windows-envvars-howto-url] describes how to setup env vars
     in Windows. We suggest to edit and execute once the
     [env-vars-setup.cmd](scripts/env-vars-setup.cmd) script included in the
     repository. The settings will persist across terminal sessions and reboots.
   * For Linux and MacOS, we suggest to edit and execute
     [env-vars-setup](scripts/env-vars-setup) each time, before starting the
     service. Depending on OS and terminal, there are ways to persist values
     globally, for more information these pages should help:
     * https://stackoverflow.com/questions/13046624/how-to-permanently-export-a-variable-in-linux
     * https://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x
     * https://help.ubuntu.com/community/EnvironmentVariables

# Feedback

Please enter issues, bugs, or suggestions as 
[GitHub Issues](https://github.com/Azure/asa-manager-dotnet/issues)

# License

Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the [MIT](LICENSE) License.

[build-badge]:https://solutionaccelerators.visualstudio.com/RemoteMonitoring/_apis/build/status/Consolidated%20Repo
[build-url]: https://solutionaccelerators.visualstudio.com/RemoteMonitoring/_build/latest?definitionId=22
[issues-badge]: https://img.shields.io/github/issues/azure/asa-manager-dotnet.svg
[issues-url]: https://github.com/azure/asa-manager-dotnet/issues
[gitter-badge]: https://img.shields.io/gitter/room/azure/iot-solutions.js.svg
[gitter-url]: https://gitter.im/azure/iot-solutions


[asa-url]: https://azure.microsoft.com/services/stream-analytics
[telemetry-microservice-url]: https://github.com/Azure/device-telemetry-dotnet
[configuration-microservice-url]: https://github.com/azure/pcs-config-dotnet
[postman-url]: https://www.getpostman.com
[dotnet-install]: https://www.microsoft.com/net/learn/get-started
[vs-install-url]: https://www.visualstudio.com/downloads
[dotnetcore-tools-url]: https://www.microsoft.com/net/core#windowsvs2017
[omnisharp-url]: https://github.com/OmniSharp/omnisharp-vscode
[windows-envvars-howto-url]: https://superuser.com/questions/949560/how-do-i-set-system-environment-variables-in-windows-10
[docker-compose-install-url]: https://docs.docker.com/compose/install
[rm-arch-url]:https://docs.microsoft.com/azure/iot-suite/iot-suite-remote-monitoring-sample-walkthrough
[run-with-docker-url]:(https://docs.microsoft.com/azure/iot-suite/iot-suite-remote-monitoring-deploy-local#run-the-microservices-in-docker)

